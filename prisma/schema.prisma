generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Authentication & Users ───────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  name           String?
  role           UserRole  @default(STAFF)
  ngoId          String?
  ngo            Ngo?      @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastLoginAt    DateTime?
  isActive       Boolean   @default(true)
  auditLogs      AuditLog[]
  sessions       Session[]
  blogPosts      BlogPost[]

  // Networking
  sentConnections     Connection[]    @relation("ConnectionRequester")
  receivedConnections Connection[]    @relation("ConnectionReceiver")
  sentMessages        DirectMessage[] @relation("MessageSender")
  receivedMessages    DirectMessage[] @relation("MessageReceiver")

  @@index([ngoId])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime

  @@index([userId])
}

enum UserRole {
  SUPER_ADMIN
  NGO_ADMIN
  STAFF
  VIEWER
}

// ─── NGO ──────────────────────────────────────────────────────────

model Ngo {
  id                String          @id @default(cuid())
  name              String
  slug              String          @unique
  description       String?
  logoUrl           String?
  websiteUrl        String?
  subscriptionPlan  SubscriptionPlan @default(BASIC)
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  users             User[]
  donors            Donor[]
  campaigns         Campaign[]
  automations       Automation[]
  donorTags         DonorTag[]
  miniSiteConfig    MiniSiteConfig?
  consentTexts      ConsentText[]
  auditLogs         AuditLog[]
  donations         Donation[]
  manualPledges     ManualDonationPledge[]
  verification      NgoVerification?

  // Stripe subscription (platform plan)
  stripeCustomerId    String?   @unique
  stripeSubscriptionId String?
  stripePriceId       String?
  subscriptionStatus  String?   @default("active")
  currentPeriodEnd    DateTime?
  trialEndsAt         DateTime?

  // Manual subscription management (by Super Admin)
  subscriptionStartAt   DateTime?   // when current plan was assigned
  subscriptionExpiresAt DateTime?   // when plan expires (null = no expiration)
  subscriptionAssignedBy String?    // user ID of admin who assigned it
  subscriptionNotes     String?     // admin notes about subscription
  lastExpirationNotice  DateTime?   // last time expiration warning was sent
  autoRenew             Boolean     @default(false) // auto-renew on expiration

  // Stripe Connect (donations go directly to NGO)
  stripeConnectId         String?   @unique  // acct_xxx - Stripe Connect account
  stripeConnectStatus     String?   @default("pending") // pending, active, restricted
  stripeConnectOnboarded  Boolean   @default(false)
  stripeChargesEnabled    Boolean   @default(false)
  stripePayoutsEnabled    Boolean   @default(false)
  stripeRequirementsJson  Json?     // requirements from Stripe
  stripeLastSyncAt        DateTime?

  // PayPal donation settings
  paypalEmail         String?   // Simple PayPal - just email address to receive donations
  paypalClientId      String?
  paypalClientSecret  String?
  paypalMerchantId    String?
  paypalEnabled       Boolean   @default(false)

  // Netopia payment settings (per-NGO, when platform Netopia is enabled)
  netopiaEnabled        Boolean   @default(false)
  netopiaMerchantId     String?   // individual NGO merchant ID (or use platform default)

  // Bank transfer / Revolut donation settings
  bankName          String?
  ibanRon           String?
  ibanEur           String?
  revolutTag        String?
  revolutPhone      String?
  revolutLink       String?

  // Donation fee config overrides (null = use plan defaults)
  donationFeePercent      Float?
  donationFeeFixedAmount  Float?    // in RON
  donationFeeMinAmount    Float?    // minimum fee in RON

  // Public profile & rankings
  isFeatured        Boolean   @default(false)  // promoted/boosted
  boostUntil        DateTime?                   // boost expiration
  rating            Float     @default(0)       // 0-5 average rating
  ratingCount       Int       @default(0)
  totalRaised       Float     @default(0)       // total donations through platform
  donorCountPublic  Int       @default(0)       // public donor count
  category          String?                     // Social, Educatie, Sanatate, Mediu, etc.
  shortDescription  String?                     // max 150 chars for cards
  coverImageUrl     String?

  // Notifications
  notifications     Notification[]

  // Documents & Forms
  formularAnaf        FormularAnaf[]
  sponsorshipContracts SponsorshipContract[]

  // Platform Invoices
  invoices            Invoice[]

  // Sponsor Companies CRM
  sponsorCompanies    SponsorCompany[]

  // LinkedIn Prospects (Chrome Extension)
  linkedInProspects   LinkedInProspect[]
  apiTokens           ApiToken[]

  // Provider settings (encrypted)
  sendgridApiKey    String?
  twilioAccountSid  String?
  twilioAuthToken   String?
  twilioPhoneNumber String?
  senderEmail       String?
  senderName        String?
  smsSenderId       String?

  // Credits system
  emailCredits      Int       @default(100)
  smsCredits        Int       @default(50)
  creditTransactions CreditTransaction[]
  emailTemplates    EmailTemplate[]
  smsTemplates      SmsTemplate[]

  // Billing details (for invoice generation)
  billingName         String?     // Denumire pe factura
  billingCui          String?     // CUI pe factura
  billingRegCom       String?     // Nr. Reg. Com.
  billingAddress      String?     // Adresa facturare
  billingCity         String?     // Oras facturare
  billingCounty       String?     // Judet facturare
  billingEmail        String?     // Email facturare
  billingPhone        String?     // Telefon facturare
  paymentMethod       String?     @default("invoice") // "recurring_card", "invoice" (manual)
  stripePaymentMethodId String?   // Saved card for recurring

  // Legal compliance
  tosAcceptedAt       DateTime?
  gdprAcceptedAt      DateTime?
  antiSpamAcceptedAt  DateTime?
  tosAcceptedBy       String?   // userId who accepted
  legalRepresentative String?
  cui                 String?   // Cod Unic Inregistrare
  ngoRegistrationDoc  String?   // URL to document
  isVerifiedSender    Boolean   @default(false)
  dailyEmailLimit     Int       @default(500)
  dailySmsLimit       Int       @default(200)
  emailsSentToday     Int       @default(0)
  smsSentToday        Int       @default(0)
  lastLimitReset      DateTime  @default(now())

  @@index([slug])
}

enum SubscriptionPlan {
  BASIC
  PRO
  ELITE
}

// ─── Donor CRM ────────────────────────────────────────────────────

model Donor {
  id                String          @id @default(cuid())
  ngoId             String
  ngo               Ngo             @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  // Contact (encrypted at app level)
  email             String?
  emailEncrypted    String?
  phone             String?
  phoneEncrypted    String?
  name              String?

  // Preferences
  preferredChannel  ContactChannel  @default(EMAIL)

  // Consent
  emailConsent      Boolean         @default(false)
  smsConsent        Boolean         @default(false)
  privacyConsent    Boolean         @default(false)

  // Status
  status            DonorStatus     @default(ACTIVE)
  isAnonymized      Boolean         @default(false)
  notes             String?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  lastDonationAt    DateTime?
  totalDonated      Float           @default(0)
  donationCount     Int             @default(0)

  // Relations
  donations         Donation[]
  consents          ConsentRecord[]
  tags              DonorTagAssignment[]
  messageRecipients MessageRecipient[]

  @@unique([ngoId, email])
  @@index([ngoId])
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([lastDonationAt])
  @@index([totalDonated])
}

enum ContactChannel {
  EMAIL
  SMS
  BOTH
}

enum DonorStatus {
  ACTIVE
  INACTIVE
  UNSUBSCRIBED
  DELETED
}

// ─── Tags ─────────────────────────────────────────────────────────

model DonorTag {
  id          String               @id @default(cuid())
  ngoId       String
  ngo         Ngo                  @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  name        String
  color       String               @default("#6366f1")
  createdAt   DateTime             @default(now())
  assignments DonorTagAssignment[]

  @@unique([ngoId, name])
  @@index([ngoId])
}

model DonorTagAssignment {
  id        String   @id @default(cuid())
  donorId   String
  donor     Donor    @relation(fields: [donorId], references: [id], onDelete: Cascade)
  tagId     String
  tag       DonorTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([donorId, tagId])
  @@index([donorId])
  @@index([tagId])
}

// ─── Donations ────────────────────────────────────────────────────

model Donation {
  id                    String        @id @default(cuid())
  ngoId                 String
  ngo                   Ngo           @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  donorId               String?
  donor                 Donor?        @relation(fields: [donorId], references: [id], onDelete: SetNull)
  amount                Float
  currency              String        @default("RON")
  campaignId            String?
  campaign              Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  isRecurring           Boolean       @default(false)
  status                DonationStatus @default(COMPLETED)
  source                String?
  paymentProvider       String?       // stripe, bank_transfer, revolut, manual
  stripePaymentIntentId String?
  stripeCheckoutSessionId String?
  paypalOrderId         String?
  applicationFeeAmount  Float?        // platform fee in RON
  metadata              Json?
  createdAt             DateTime      @default(now())

  @@index([ngoId])
  @@index([donorId])
  @@index([campaignId])
  @@index([createdAt])
  @@index([paymentProvider])
  @@index([stripePaymentIntentId])
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ─── Manual Donation Pledges (bank transfer / Revolut) ──────────

model ManualDonationPledge {
  id              String              @id @default(cuid())
  ngoId           String
  ngo             Ngo                 @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  donorName       String?
  donorEmail      String?
  donorPhone      String?
  amount          Float?
  currency        String              @default("RON")
  paymentMethod   String              // bank_transfer, revolut
  referenceCode   String              @unique // ONG-XXXX unique reference
  proofFilePath   String?             // uploaded proof file
  status          PledgeStatus        @default(PENDING)
  adminNotes      String?
  verifiedBy      String?             // userId who verified
  verifiedAt      DateTime?
  donationId      String?             // linked Donation record after verification
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([ngoId])
  @@index([status])
  @@index([referenceCode])
  @@index([createdAt])
}

enum PledgeStatus {
  PENDING
  VERIFIED
  REJECTED
}

// ─── Consent ──────────────────────────────────────────────────────

model ConsentRecord {
  id          String        @id @default(cuid())
  donorId     String
  donor       Donor         @relation(fields: [donorId], references: [id], onDelete: Cascade)
  type        ConsentType
  granted     Boolean
  ipAddress   String?
  userAgent   String?
  source      String?       // "donation_form", "newsletter", "minisite"
  campaignId  String?
  consentText String?       // snapshot of the consent text at time of consent
  createdAt   DateTime      @default(now())

  @@index([donorId])
  @@index([type])
  @@index([createdAt])
}

enum ConsentType {
  EMAIL_MARKETING
  SMS_MARKETING
  PRIVACY_POLICY
  TERMS_OF_SERVICE
}

model ConsentText {
  id        String   @id @default(cuid())
  ngoId     String
  ngo       Ngo      @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  type      ConsentType
  text      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ngoId, type])
}

// ─── Campaigns ────────────────────────────────────────────────────

model Campaign {
  id              String          @id @default(cuid())
  ngoId           String
  ngo             Ngo             @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  name            String
  type            CampaignType
  channel         CampaignChannel
  status          CampaignStatus  @default(DRAFT)

  // Email fields
  subject         String?
  emailBody       String?         // HTML
  previewText     String?

  // SMS fields
  smsBody         String?

  // Targeting
  segmentQuery    Json?           // Stored segment filter
  recipientCount  Int             @default(0)

  // Scheduling
  scheduledAt     DateTime?
  sentAt          DateTime?
  completedAt     DateTime?

  // Fundraising goal
  goalAmount      Float?
  currentAmount   Float           @default(0)

  // A/B testing
  isAbTest        Boolean         @default(false)
  variantA        Json?
  variantB        Json?

  // Stats
  totalSent       Int             @default(0)
  totalDelivered  Int             @default(0)
  totalOpened     Int             @default(0)
  totalClicked    Int             @default(0)
  totalBounced    Int             @default(0)
  totalComplaints Int             @default(0)
  totalUnsubscribed Int           @default(0)

  // Legal consent (logged per campaign)
  consentConfirmed    Boolean     @default(false)
  consentConfirmedAt  DateTime?
  consentConfirmedBy  String?     // userId
  consentIp           String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  messages        Message[]
  donations       Donation[]
  automationSteps AutomationStep[]
  sendConsents    CampaignSendConsent[]

  @@index([ngoId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

enum CampaignType {
  THANK_YOU
  UPDATE
  EMERGENCY_APPEAL
  NEWSLETTER
  REACTIVATION
  CORPORATE_OUTREACH
  CUSTOM
}

enum CampaignChannel {
  EMAIL
  SMS
  BOTH
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

// ─── Messages ─────────────────────────────────────────────────────

model Message {
  id          String          @id @default(cuid())
  campaignId  String?
  campaign    Campaign?       @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  channel     CampaignChannel
  subject     String?
  body        String
  status      MessageStatus   @default(QUEUED)
  createdAt   DateTime        @default(now())
  sentAt      DateTime?

  recipients  MessageRecipient[]

  @@index([campaignId])
  @@index([status])
}

model MessageRecipient {
  id          String              @id @default(cuid())
  messageId   String
  message     Message             @relation(fields: [messageId], references: [id], onDelete: Cascade)
  donorId     String
  donor       Donor               @relation(fields: [donorId], references: [id], onDelete: Cascade)
  channel     CampaignChannel
  address     String              // email or phone
  status      DeliveryStatus      @default(PENDING)
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?
  errorMsg    String?
  createdAt   DateTime            @default(now())

  @@index([messageId])
  @@index([donorId])
  @@index([status])
}

enum MessageStatus {
  QUEUED
  SENDING
  SENT
  FAILED
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
  COMPLAINED
  UNSUBSCRIBED
}

// ─── Automations ──────────────────────────────────────────────────

model Automation {
  id          String            @id @default(cuid())
  ngoId       String
  ngo         Ngo               @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  name        String
  description String?
  trigger     AutomationTrigger
  triggerConfig Json?
  isActive    Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  steps       AutomationStep[]
  executions  AutomationExecution[]

  @@index([ngoId])
  @@index([trigger])
  @@index([isActive])
}

enum AutomationTrigger {
  NEW_DONATION
  CAMPAIGN_GOAL_REACHED
  NO_DONATION_PERIOD
  NEW_SUBSCRIBER
  CAMPAIGN_ENDED
  LOW_PERFORMANCE
  MANUAL
}

model AutomationStep {
  id            String          @id @default(cuid())
  automationId  String
  automation    Automation      @relation(fields: [automationId], references: [id], onDelete: Cascade)
  order         Int
  action        AutomationAction
  config        Json            // Action-specific config
  delayMinutes  Int             @default(0)
  campaignId    String?
  campaign      Campaign?       @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  createdAt     DateTime        @default(now())

  @@index([automationId])
  @@unique([automationId, order])
}

enum AutomationAction {
  SEND_EMAIL
  SEND_SMS
  ADD_TAG
  REMOVE_TAG
  NOTIFY_ADMIN
  AI_SUGGESTION
  WAIT
  CONDITION
}

model AutomationExecution {
  id            String    @id @default(cuid())
  automationId  String
  automation    Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  donorId       String?
  status        String    @default("running") // running, completed, failed
  currentStep   Int       @default(0)
  data          Json?
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  error         String?

  @@index([automationId])
  @@index([status])
}

// ─── Mini-Site ────────────────────────────────────────────────────

model MiniSiteConfig {
  id              String   @id @default(cuid())
  ngoId           String   @unique
  ngo             Ngo      @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  // Hero section
  heroTitle       String?
  heroDescription String?
  heroCtaText     String?  @default("Doneaza acum")

  // About & Mission (AI-generated)
  aboutText       String?
  aboutImageUrl   String?
  missionText     String?
  impactText      String?

  // Contact info
  contactEmail    String?
  contactPhone    String?
  contactAddress  String?

  // Legal / Association data
  cui             String?
  registrationNr  String?
  bankAccount     String?
  bankName        String?

  // Social links
  socialFacebook  String?
  socialInstagram String?
  socialLinkedin  String?
  socialTwitter   String?
  socialYoutube   String?
  socialTiktok    String?

  // Appearance
  primaryColor    String   @default("#6366f1")
  accentColor     String   @default("#f59e0b")
  theme           String   @default("modern")

  // Section toggles
  showNewsletter  Boolean  @default(true)
  showDonation    Boolean  @default(true)
  showUpdates     Boolean  @default(true)
  showAbout       Boolean  @default(true)
  showMission     Boolean  @default(true)
  showImpact      Boolean  @default(true)
  showContact     Boolean  @default(true)
  showSocial      Boolean  @default(true)
  showFormular230 Boolean  @default(false)
  showContract    Boolean  @default(false)

  // Formular 230 (from formular230.ro)
  formular230EmbedCode String?
  formular230PdfUrl    String?  // URL to uploaded PDF form
  formular230Address   String?  // Mailing address for completed forms

  // Mini-site campaigns [{id, title, description, goalAmount, raisedAmount, imageUrl, ctaText, ctaLink, category, isActive}]
  miniSiteCampaigns    Json?

  // AI template style (for unique sites)
  templateStyle        String?  @default("modern")

  // Video embed (YouTube/Vimeo)
  videoUrl             String?
  showVideo            Boolean  @default(false)

  // Team members [{name, role, photoUrl, bio}]
  teamMembers          Json?
  showTeam             Boolean  @default(false)

  // Testimonials [{name, role, text, photoUrl}]
  testimonials         Json?
  showTestimonials     Boolean  @default(false)

  // Partners [{name, logoUrl, websiteUrl}]
  partners             Json?
  showPartners         Boolean  @default(false)

  // Events [{title, date, location, description, imageUrl}]
  events               Json?
  showEvents           Boolean  @default(false)

  // FAQ [{question, answer}]
  faqItems             Json?
  showFaq              Boolean  @default(false)

  // Volunteer form
  showVolunteerForm    Boolean  @default(false)

  // Transparency docs [{title, year, pdfUrl}]
  transparencyDocs     Json?
  showTransparency     Boolean  @default(false)

  // Urgent banner {text, ctaText, ctaUrl, isActive, bgColor}
  urgentBanner         Json?
  showUrgentBanner     Boolean  @default(false)

  // Google Maps embed
  googleMapsEmbed      String?
  showGoogleMaps       Boolean  @default(false)

  // Donation popup
  showDonationPopup    Boolean  @default(false)
  donationPopupDelay   Int?     @default(15)
  donationPopupText    String?

  // SEO
  seoTitle             String?
  seoDescription       String?
  seoKeywords          String?

  // Counter stats [{label, value, suffix}]
  counterStats         Json?
  showCounterStats     Boolean  @default(false)

  // Extra
  customCss       String?
  customSections  Json?    // [{title, content, icon}]
  isPublished     Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ─── Audit Log ────────────────────────────────────────────────────

model AuditLog {
  id          String   @id @default(cuid())
  ngoId       String?
  ngo         Ngo?     @relation(fields: [ngoId], references: [id], onDelete: SetNull)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      String
  entityType  String?
  entityId    String?
  details     Json?
  ipAddress   String?
  createdAt   DateTime @default(now())

  @@index([ngoId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
}

// ─── SMS Opt-Out List ─────────────────────────────────────────────

model SmsOptOut {
  id          String   @id @default(cuid())
  phoneNumber String
  ngoId       String?
  createdAt   DateTime @default(now())

  @@unique([phoneNumber, ngoId])
  @@index([phoneNumber])
}

// ─── NGO Verification ────────────────────────────────────────────

model NgoVerification {
  id                String             @id @default(cuid())
  ngoId             String             @unique
  ngo               Ngo                @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  status            VerificationStatus @default(PENDING)

  // Organization details
  registrationNumber String?           // CUI / CIF
  registrationDate   DateTime?
  legalForm          String?           // Asociatie, Fundatie, Federatie
  fiscalCode         String?
  address            String?
  county             String?
  city               String?
  representativeName String?
  representativeRole String?

  // Documents
  registrationCertUrl  String?         // Certificat de inregistrare
  statuteDocUrl        String?         // Statut / Act constitutiv
  fiscalCertUrl        String?         // Certificat fiscal
  courtDecisionUrl     String?         // Hotarare judecatoreasca

  // AI Verification
  aiScore            Float?            // 0-100 confidence score
  aiAnalysis         Json?             // AI analysis details
  aiFlags            Json?             // Potential issues flagged by AI

  // Review
  reviewedBy         String?
  reviewedAt         DateTime?
  reviewNotes        String?
  rejectionReason    String?

  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@index([status])
}

enum VerificationStatus {
  PENDING
  IN_REVIEW
  AI_CHECKED
  APPROVED
  REJECTED
  SUSPENDED
}

// ─── Blog ────────────────────────────────────────────────────────

model BlogPost {
  id          String        @id @default(cuid())
  slug        String        @unique
  title       String
  excerpt     String?
  content     String        // HTML content
  coverImage  String?
  authorId    String
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  status      PostStatus    @default(DRAFT)
  category    String?
  tags        String[]      @default([])
  publishedAt DateTime?
  featured    Boolean       @default(false)
  viewCount   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status])
  @@index([slug])
  @@index([publishedAt])
  @@index([category])
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ─── Site Pages (CMS) ────────────────────────────────────────────

model SitePage {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  content     Json       // Structured content blocks
  metaTitle   String?
  metaDesc    String?
  isPublished Boolean    @default(false)
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([isPublished])
}

// ─── Platform Settings ───────────────────────────────────────────

model PlatformSettings {
  id              String   @id @default("platform")
  siteName        String   @default("Binevo")
  siteDescription String?
  logoUrl         String?
  primaryColor    String   @default("#6366f1")
  heroTitle       String?
  heroSubtitle    String?
  heroCtaText     String?
  statsEnabled    Boolean  @default(true)
  featuresJson    Json?    // Homepage features config
  plansJson       Json?    // Pricing plans config
  footerText      String?
  contactEmail    String?
  socialLinks     Json?    // { facebook, twitter, linkedin, etc }
  // AI & Service API Keys (managed from Super Admin panel)
  openaiApiKey    String?
  anthropicApiKey String?
  googleAiApiKey  String?
  sendgridApiKey  String?
  twilioSid       String?
  twilioToken     String?
  twilioPhone     String?

  // ─── SMTP / Email Sender Configuration ─────────────────
  emailProvider       String   @default("smtp")    // smtp, sendgrid, mailgun
  smtpHost            String?
  smtpPort            Int?     @default(587)
  smtpUser            String?
  smtpPassword        String?
  smtpEncryption      String   @default("tls")     // tls, ssl, none
  smtpFromEmail       String?                       // sender email for platform notifications
  smtpFromName        String?  @default("Binevo")  // sender name
  smtpReplyTo         String?                       // reply-to address
  mailgunApiKey       String?
  mailgunDomain       String?
  mailgunRegion       String   @default("eu")      // eu, us

  // Notification settings
  notifyOnRegistration    Boolean @default(true)   // email on new NGO registration
  notifyOnVerification    Boolean @default(true)   // email on verification status change
  notifyOnSubscription    Boolean @default(true)   // email on subscription changes
  notifyOnDonation        Boolean @default(true)   // email on new donations
  notifyOnInvoice         Boolean @default(true)   // automated invoice emails
  notifyWelcomeEmail      Boolean @default(true)   // welcome email to new users
  invoicePrefix           String  @default("BNV")  // invoice number prefix
  invoiceNextNumber       Int     @default(1)      // next invoice number

  // ─── Payment Processors Configuration ─────────────────
  // Which payment processors are enabled at platform level
  paymentProcessors       Json?    // { stripe: { enabled, mode }, netopia: { enabled }, paypal: { enabled } }

  // Stripe (platform-level keys for Stripe Connect)
  stripeEnabled           Boolean  @default(true)
  stripeSecretKey         String?
  stripePublishableKey    String?
  stripeConnectWebhookSecret String?
  stripeWebhookSecret     String?

  // Netopia (Romanian payment processor)
  netopiaEnabled          Boolean  @default(false)
  netopiaApiKey           String?   // Netopia API key (POS Signature / API Key)
  netopiaMerchantId       String?   // Netopia Merchant ID
  netopiaPublicKey        String?   @db.Text // Netopia public certificate (PEM)
  netopiaPrivateKey       String?   @db.Text // Netopia private key (PEM)
  netopiaSandbox          Boolean  @default(true) // true = test mode, false = production
  netopiaNotifyUrl        String?   // IPN callback URL

  // PayPal (platform-level)
  paypalPlatformEnabled   Boolean  @default(false)
  paypalPlatformClientId  String?
  paypalPlatformSecret    String?
  paypalPlatformSandbox   Boolean  @default(true)

  // ─── e-Factura (ANAF SPV) Configuration ────────────────
  eFacturaEnabled         Boolean  @default(false)
  eFacturaAutoSend        Boolean  @default(false)  // auto-send to ANAF on invoice creation
  anafClientId            String?                     // OAuth2 client ID from ANAF
  anafClientSecret        String?                     // OAuth2 client secret
  anafAccessToken         String?  @db.Text           // Current OAuth2 access token
  anafRefreshToken        String?  @db.Text           // OAuth2 refresh token
  anafTokenExpiresAt      DateTime?                   // Token expiration
  anafSandbox             Boolean  @default(true)     // true = test, false = production
  anafCui                 String?                     // CUI for SPV (must match company CUI)
  anafCallbackUrl         String?                     // OAuth callback URL

  updatedAt       DateTime @updatedAt
}

// ─── Notifications ───────────────────────────────────────────────

model Notification {
  id          String           @id @default(cuid())
  ngoId       String
  ngo         Ngo              @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String
  isRead      Boolean          @default(false)
  actionUrl   String?
  metadata    Json?
  createdAt   DateTime         @default(now())

  @@index([ngoId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

enum NotificationType {
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_UPGRADED
  SUBSCRIPTION_DOWNGRADED
  PAYMENT_FAILED
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  SYSTEM
  CAMPAIGN_COMPLETED
  DONATION_RECEIVED
  CONNECTION_REQUEST
  NEW_MESSAGE
  CONTRACT_SIGNED
}

// ─── ANAF Formular 230 (3.5% redirect) ──────────────────────────

model FormularAnaf {
  id              String   @id @default(cuid())
  ngoId           String
  ngo             Ngo      @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  // Contributor data (persoana fizica)
  cnp             String?
  firstName       String
  lastName        String
  street          String?
  number          String?
  block           String?
  staircase       String?
  floor           String?
  apartment       String?
  city            String
  county          String
  postalCode      String?
  phone           String?
  email           String?

  // NGO data (auto-filled)
  ngoName         String
  ngoCui          String   // CUI/CIF of NGO
  ngoIban         String?
  ngoContractNr   String?

  // Tax year
  taxYear         Int
  percentage      Float    @default(3.5)

  // Status
  status          FormStatus @default(GENERATED)
  signedAt        DateTime?
  downloadCount   Int       @default(0)
  pdfUrl          String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ngoId])
  @@index([taxYear])
  @@index([status])
}

enum FormStatus {
  GENERATED
  DOWNLOADED
  SIGNED
  SUBMITTED
}

// ─── Sponsorship Contracts ───────────────────────────────────────

model SponsorshipContract {
  id              String          @id @default(cuid())
  ngoId           String
  ngo             Ngo             @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  // Company data
  companyName     String
  companyCui      String          // CUI/CIF
  companyAddress  String
  companyCounty   String?
  companyCity     String?
  companyRep      String          // Representative name
  companyRepRole  String?         // Representative role (Director, Administrator)
  companyEmail    String?
  companyPhone    String?
  companyIban     String?

  // NGO data (auto-filled)
  ngoName         String
  ngoCui          String
  ngoAddress      String?
  ngoRep          String?
  ngoRepRole      String?
  ngoIban         String?

  // Contract details
  contractNumber  String
  contractDate    DateTime        @default(now())
  amount          Float
  currency        String          @default("RON")
  purpose         String?         // Sponsorship purpose/destination
  duration        String?         // Contract duration
  paymentTerms    String?         // Payment terms

  // Status
  status          ContractStatus  @default(DRAFT)
  signedByCompany Boolean         @default(false)
  signedByNgo     Boolean         @default(false)
  signedAt        DateTime?
  pdfUrl          String?
  downloadCount   Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([ngoId])
  @@index([status])
  @@index([companyName])
}

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  ACTIVE
  COMPLETED
  CANCELLED
}

// ─── Networking (LinkedIn-style connections) ─────────────────────

model Connection {
  id              String           @id @default(cuid())
  requesterId     String           // User who sent request
  requester       User             @relation("ConnectionRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  receiverId      String           // User who receives request
  receiver        User             @relation("ConnectionReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status          ConnectionStatus @default(PENDING)
  message         String?          // Connection request message

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([requesterId, receiverId])
  @@index([requesterId])
  @@index([receiverId])
  @@index([status])
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

model DirectMessage {
  id              String   @id @default(cuid())
  senderId        String
  sender          User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId      String
  receiver        User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  content         String
  isRead          Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

// ─── Sponsor Companies CRM ──────────────────────────────────────

model SponsorCompany {
  id                String              @id @default(cuid())
  ngoId             String
  ngo               Ngo                 @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  name              String
  domain            String?             // website domain
  website           String?
  industry          String?
  city              String?
  country           String              @default("Romania")
  status            SponsorCompanyStatus @default(NEW)
  tags              String[]            @default([])
  notes             String?

  lastContactedAt   DateTime?
  nextFollowupAt    DateTime?

  createdBy         String?             // userId who added
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  contacts          SponsorContact[]
  interactions      SponsorInteraction[]
  aiMatches         SponsorAiMatch[]

  @@unique([ngoId, name, city])
  @@index([ngoId])
  @@index([status])
  @@index([industry])
  @@index([nextFollowupAt])
}

enum SponsorCompanyStatus {
  NEW
  CONTACTED
  REPLIED
  MEETING
  SPONSOR
  NOT_INTERESTED
  LATER
}

model SponsorContact {
  id                String              @id @default(cuid())
  companyId         String
  company           SponsorCompany      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  fullName          String
  role              String?             // job title
  email             String?
  phone             String?
  linkedinUrl       String?
  status            SponsorContactStatus @default(NEW)
  notes             String?
  dncFlag           Boolean             @default(false) // Do Not Contact

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  interactions      SponsorInteraction[]

  @@index([companyId])
  @@index([email])
  @@index([status])
}

enum SponsorContactStatus {
  NEW
  CONTACTED
  REPLIED
  DO_NOT_CONTACT
}

model SponsorInteraction {
  id                String              @id @default(cuid())
  companyId         String
  company           SponsorCompany      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId         String?
  contact           SponsorContact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)

  type              InteractionType
  subject           String?
  body              String?
  createdBy         String?             // userId

  createdAt         DateTime            @default(now())

  @@index([companyId])
  @@index([contactId])
  @@index([type])
  @@index([createdAt])
}

enum InteractionType {
  NOTE
  EMAIL_SENT
  EMAIL_RECEIVED
  CALL
  MEETING
  AI_MATCH
  STATUS_CHANGE
}

model SponsorAiMatch {
  id                String              @id @default(cuid())
  companyId         String
  company           SponsorCompany      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  ngoId             String

  score             Int                 // 0-100
  reasons           Json                // string[] of 3 reasons
  angle             String?             // education/medical/social/children/elderly/environment/local
  rawAnalysis       String?             // full AI response

  feedbackAccepted  Boolean?            // null = no feedback yet
  createdAt         DateTime            @default(now())

  @@index([companyId])
  @@index([ngoId])
  @@index([score])
}

// ─── Email & SMS Templates ──────────────────────────────────────

model EmailTemplate {
  id          String   @id @default(cuid())
  ngoId       String?
  ngo         Ngo?     @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  name        String
  category    String   // thank_you, newsletter, emergency, reactivation, event, impact_report
  subject     String
  htmlBody    String   @db.Text
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ngoId])
  @@index([category])
}

model SmsTemplate {
  id          String   @id @default(cuid())
  ngoId       String?
  ngo         Ngo?     @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  name        String
  category    String   // thank_you, reminder, emergency, update
  body        String
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ngoId])
  @@index([category])
}

// ─── Credit System ──────────────────────────────────────────────

model CreditTransaction {
  id          String   @id @default(cuid())
  ngoId       String
  ngo         Ngo      @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  type        CreditTransactionType
  channel     CreditChannel
  amount      Int      // positive = credit added, negative = credit used
  balance     Int      // balance after transaction
  description String?
  campaignId  String?
  createdAt   DateTime @default(now())

  @@index([ngoId])
  @@index([type])
  @@index([createdAt])
}

enum CreditTransactionType {
  PURCHASE
  USAGE
  BONUS
  REFUND
  ADMIN_ADJUSTMENT
}

enum CreditChannel {
  EMAIL
  SMS
}

// ─── Legal Compliance ───────────────────────────────────────────

model CampaignSendConsent {
  id              String   @id @default(cuid())
  campaignId      String
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId          String
  ngoId           String
  consentText     String   // exact text shown to user
  confirmed       Boolean  @default(true)
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  @@index([campaignId])
  @@index([ngoId])
  @@index([userId])
}

model GlobalBlacklist {
  id          String   @id @default(cuid())
  type        BlacklistType  // EMAIL or PHONE
  value       String         // the email or phone (hashed for privacy)
  rawValue    String?        // original for lookup (encrypted)
  reason      String         // UNSUBSCRIBE, BOUNCE, COMPLAINT, MANUAL
  sourceNgoId String?        // which NGO triggered this
  createdAt   DateTime @default(now())

  @@unique([type, value])
  @@index([type, value])
}

enum BlacklistType {
  EMAIL
  PHONE
}

// ─── API Tokens (Chrome Extension Auth) ────────────────────────

model ApiToken {
  id          String    @id @default(cuid())
  ngoId       String
  ngo         Ngo       @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  userId      String
  token       String    @unique
  name        String    @default("Chrome Extension")
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([token])
  @@index([ngoId])
}

// ─── LinkedIn Prospects (Chrome Extension Import) ──────────────

model LinkedInProspect {
  id                String                 @id @default(cuid())
  ngoId             String
  ngo               Ngo                    @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  // LinkedIn profile data
  fullName          String
  headline          String?
  company           String?
  location          String?
  profileUrl        String
  profileImageUrl   String?

  // AI matching & analysis
  aiMatchScore      Int?
  aiMatchReasons    Json?
  aiAnalysis        Json?
  aiAnalyzedAt      DateTime?

  // Status tracking
  status            LinkedInProspectStatus @default(NEW)
  tags              String[]               @default([])
  notes             String?

  // Messaging
  lastMessageAt     DateTime?
  messageCount      Int                    @default(0)

  // Import metadata
  importedBy        String?
  importSource      String?

  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  @@unique([ngoId, profileUrl])
  @@index([ngoId])
  @@index([status])
  @@index([aiMatchScore])
  @@index([createdAt])
}

enum LinkedInProspectStatus {
  NEW
  ANALYZED
  CONTACTED
  REPLIED
  MEETING
  CONVERTED
  NOT_INTERESTED
}

// ─── Platform Billing (Super Admin Company Details) ─────────────

model PlatformBilling {
  id                String   @id @default("billing")

  // Company details
  companyName       String?
  companyCui        String?   // CUI (Cod Unic de Inregistrare)
  companyRegCom     String?   // Nr. Reg. Com. (J12/345/2020)
  companyAddress    String?
  companyCity       String?
  companyCounty     String?
  companyPostalCode String?
  companyCountry    String   @default("Romania")
  companyEmail      String?
  companyPhone      String?
  companyIban       String?
  companyBankName   String?
  companyVatPayer   Boolean  @default(false) // Platitor de TVA
  companyCapital    String?   // Capital social

  // Invoice settings
  invoicePrefix     String   @default("BNV")
  invoiceNextNumber Int      @default(1)
  invoiceSeries     String?  // Serie factura (ex: BNV)
  invoiceCurrency   String   @default("RON")
  invoiceVatRate    Float    @default(19)   // TVA rate (%)
  invoiceNotes      String?  // Default notes on invoices
  invoicePaymentTerms Int    @default(30)   // Termen de plata (zile)

  updatedAt         DateTime @updatedAt
}

// ─── Invoices (Platform Invoices) ───────────────────────────────

model Invoice {
  id                String        @id @default(cuid())

  // Invoice number
  invoiceNumber     String        @unique // e.g. BNV-0001
  invoiceSeries     String?

  // Seller (Platform - from PlatformBilling)
  sellerName        String
  sellerCui         String?
  sellerRegCom      String?
  sellerAddress     String?
  sellerCity        String?
  sellerCounty      String?
  sellerEmail       String?
  sellerPhone       String?
  sellerIban        String?
  sellerBankName    String?
  sellerVatPayer    Boolean       @default(false)

  // Buyer (NGO or external client)
  buyerName         String
  buyerCui          String?
  buyerRegCom       String?
  buyerAddress      String?
  buyerCity         String?
  buyerCounty       String?
  buyerEmail        String?
  buyerPhone        String?

  // Link to NGO if applicable
  ngoId             String?

  // Invoice details
  issueDate         DateTime      @default(now())
  dueDate           DateTime?
  status            InvoiceStatus @default(DRAFT)

  // Items stored as JSON array
  // [{description, quantity, unitPrice, vatRate, totalNet, totalVat, totalGross}]
  items             Json

  // Totals
  subtotal          Float         @default(0)   // Total fara TVA
  vatAmount         Float         @default(0)   // Total TVA
  totalAmount       Float         @default(0)   // Total cu TVA
  currency          String        @default("RON")

  // Payment
  paidAt            DateTime?
  paymentMethod     String?       // stripe, bank_transfer, cash

  // Public payment link
  paymentToken      String?       @unique  // unique token for public payment page
  paymentProofUrl   String?       // uploaded proof of bank transfer
  paymentProofNote  String?       // note from payer about the payment
  stripePaymentIntentId String?   // Stripe payment intent for card payments

  // Subscription link
  subscriptionPlan  String?       // PRO, ELITE - which plan this invoice is for
  subscriptionMonth String?       // e.g. "2026-02" - billing period
  isRecurring       Boolean       @default(false) // part of recurring billing

  // Notes
  notes             String?
  internalNotes     String?

  // e-Factura (ANAF SPV integration)
  eFacturaStatus    String?       // pending, uploaded, validated, rejected, storno
  eFacturaId        String?       // ID-ul din sistemul ANAF (index_incarcare)
  eFacturaUploadId  String?       // ID upload ANAF
  eFacturaXml       String?       @db.Text // UBL XML generat
  eFacturaErrors    Json?         // Erori de validare ANAF
  eFacturaSentAt    DateTime?     // Data trimiterii la ANAF
  eFacturaValidAt   DateTime?     // Data validarii de ANAF

  // Metadata
  createdBy         String?       // userId who created
  metadata          Json?         // Additional metadata
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  ngo               Ngo?          @relation(fields: [ngoId], references: [id])

  @@index([ngoId])
  @@index([status])
  @@index([issueDate])
  @@index([invoiceNumber])
  @@index([paymentToken])
  @@index([eFacturaStatus])
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  OVERDUE
  CANCELLED
  STORNO
}
